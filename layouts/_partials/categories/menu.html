{{ if .Site.Taxonomies.categories }}
<div class="book-categories">
  <input type="checkbox" class="hidden toggle" id="categories-control" checked />
  <label for="categories-control" class="categories-toggle categories-link">
    <!-- `전체` 카테고리 링크 -> 카테고리 terms 페이지로 연결 -->
    <a href="/categories/">
      <i class="fa-solid fa-folder"></i>
      <span>{{ default "전체" .Site.Params.BookMenu.categoriesLabel }}</span>
      <span class="category-count">({{ len (where .Site.RegularPages "Section" "posts") }})</span>
    </a>
    <i class="fa-solid fa-chevron-down categories-arrow"></i>
  </label>
 
  <ul class="categories-menu" id="categories-menu">
    <!-- 부모-자식 카테고리 트리 구성 -->
    {{ $categoryTree := dict }}
    {{ range (where .Site.RegularPages "Section" "posts") }}
      {{ if .Params.categories }}
        {{ $parent := partial "categories/value-first" .Params.categories | string }}
        {{ if $parent }}
          <!-- 부모 카테고리 목록 구성 -->
          {{ if not (index $categoryTree $parent) }}
            {{ $categoryTree = $categoryTree | merge (dict $parent dict) }}
          {{ end }}
 
          {{ $child := partial "categories/value-second" .Params.categories | string }}
          {{ if $child }}
            <!-- 부모 카테고리에 대한 자식 카테고리 목록 구성 -->
            {{ $children := index $categoryTree $parent }}
            {{ if not (index $children $child) }}
              {{ $children = $children | merge (dict $child dict) }}
              {{ $categoryTree = $categoryTree | merge (dict $parent $children) }}
            {{ end }}
          {{ end }}
        {{ end }}
      {{ end }}
    {{ end }}
 
    {{ range $parent, $children := $categoryTree }}
 
    <!-- 부모 카테고리와 연관된 게시글 수를 카운팅 -->
    {{ $parentCount := 0 }}
    {{ range (where $.Site.RegularPages "Section" "posts") }}
      {{ if .Params.categories }}
        {{ if eq $parent (partial "categories/value-first" .Params.categories | string) }}
          {{ $parentCount = add $parentCount 1 }}
        {{ end }}
      {{ end }}
    {{ end }}
 
    <li>
      {{ if $children }}
      <input type="checkbox" class="hidden toggle" id="cat-{{ $parent | urlize }}" />
      <label for="cat-{{ $parent | urlize }}" class="categories-toggle categories-link">
        <a href="/categories/{{ $parent | urlize }}/">
          {{ partial "categories/icon" (dict "name" $parent "defaultIcon" "fa-solid fa-folder") }}
          {{ $parent }}
          <span class="category-count">({{ $parentCount }})</span>
        </a>
        <i class="fa-solid fa-chevron-down categories-arrow"></i>
      </label>
      <ul>
        {{ range $child, $_ := $children }}
 
        <!-- 자식 카테고리와 연관된 게시글 수를 카운팅 -->
        {{ $childCount := 0 }}
        {{ range (where $.Site.RegularPages "Section" "posts") }}
          {{ if .Params.categories }}
            {{ if eq (printf "%s/%s" $parent $child) (partial "categories/value" .Params.categories | string) }}
              {{ $childCount = add $childCount 1 }}
            {{ end }}
          {{ end }}
        {{ end }}
 
        <li class="categories-link">
          <a href="/categories/{{ $parent | urlize }}/{{ $child | urlize }}/">
            {{ partial "categories/icon" (dict "name" $child "defaultIcon" "fa-solid fa-file") }}
            {{ $child }}
            <span class="category-count">({{ $childCount }})</span>
          </a>
        </li>
        {{ end }}
      </ul>
      {{ else }}
      <a href="/categories/{{ $parent | urlize }}/">
        {{ partial "categories/icon" (dict "name" $parent "defaultIcon" "fa-solid fa-file") }}
        {{ $parent }}
        <span class="category-count">({{ $parentCount }})</span>
      </a>
      {{ end }}
    </li>
    {{ end }}
  </ul>
</div>
{{ end }}